<script>
const links = [
{ n: "Nexora", u: "https://mathematicss.global.ssl.fastly.net" },
{ n: "Luminal", u: "https://sciencea.global.ssl.fastly.net" },
{ n: "Hideout", u: "https://artsuplies.global.ssl.fastly.net" },
{ n: "Holy Tuna", u: "https://fishingsuplies.global.ssl.fastly.net" },
{ n: "Noah Hub", u: "https://memeresetaintgonnawork.global.ssl.fastly.net" },
{ n: "Velara", u: "https://t2026soon.global.ssl.fastly.net" },
{ n: "Strongdog", u: "https://spanishtranslator.global.ssl.fastly.net" },
{ n: "Movies", u: "https://mrbeastisrich.global.ssl.fastly.net" },
{ n: "Petezah", u: "https://AAbattery.global.ssl.fastly.net" },
{ n: "Roblox", u: "https://our-ddddd.global.ssl.fastly.net" },
{ n: "Froggie", u: "https://froggie.global.ssl.fastly.net" },
{ n: "Interstellar", u: "https://interstellar.global.ssl.fastly.net" },
{ n: "Utopia", u: "https://utopia.global.ssl.fastly.net" },
{ n: "Shadow", u: "https://shadow.global.ssl.fastly.net" },
{ n: "Nebula", u: "https://nebula.global.ssl.fastly.net" },
{ n: "Zenith", u: "https://zenith.global.ssl.fastly.net" }
];

let pImg = null;
let particles = [];
let cvs, ctx;
let animationId;

window.onload = () => {
  cvs = document.getElementById('particleCanvas');
  ctx = cvs.getContext('2d');
  resizeCanvas();
  renderGrid();
  initClock();
  initCursor();
  loadSettings();
  updateParticles();
  loop();
};

window.addEventListener("resize", () => {
  resizeCanvas();
});

function resizeCanvas() {
  if (!cvs) return;
  cvs.width = window.innerWidth;
  cvs.height = window.innerHeight;
}

function switchTab(id, el) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  el.classList.add('active');
}

function renderGrid() {
  const g = document.getElementById('grid');
  g.innerHTML = ""; // FIX: prevent duplication
  links.forEach(l => {
    const b = document.createElement('a');
    b.className = 'box';
    b.href = l.u;
    b.target = "_blank";
    b.innerHTML = `<span>${l.n}</span>`;
    g.appendChild(b);
  });
}

function updateParticles() {
  const count = parseInt(document.getElementById('partCount').value);
  const emoji = document.getElementById('emojiIn').value || 'â€¢';

  particles = [];

  for (let i = 0; i < count; i++) {
    particles.push({
      x: Math.random() * cvs.width,
      y: Math.random() * cvs.height,
      vx: (Math.random() - 0.5) * 1.2,
      vy: (Math.random() - 0.5) * 1.2,
      size: Math.random() * 15 + 10,
      emoji: emoji
    });
  }

  localStorage.setItem('nx_emoji', emoji);
  localStorage.setItem('nx_pcount', count);
}

function setPartImg(input) {
  if (!input.files[0]) return;

  if (input.files[0].size > 2 * 1024 * 1024) {
    alert("Image too large. Use under 2MB.");
    return;
  }

  const r = new FileReader();
  r.onload = (e) => {
    const tempImg = new Image();
    tempImg.onload = () => {
      pImg = tempImg;
      localStorage.setItem('nx_pimg', e.target.result);
    };
    tempImg.src = e.target.result;
  };
  r.readAsDataURL(input.files[0]);
}

function loop() {
  ctx.clearRect(0, 0, cvs.width, cvs.height);

  const accent = getComputedStyle(document.documentElement)
    .getPropertyValue('--accent');

  ctx.fillStyle = accent;

  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;

    if (p.x < -30) p.x = cvs.width + 30;
    if (p.x > cvs.width + 30) p.x = -30;
    if (p.y < -30) p.y = cvs.height + 30;
    if (p.y > cvs.height + 30) p.y = -30;

    ctx.globalAlpha = 0.4;

    if (pImg && pImg.complete) {
      ctx.drawImage(pImg, p.x, p.y, p.size, p.size);
    } else {
      ctx.font = `${p.size}px Arial`;
      ctx.fillText(p.emoji, p.x, p.y);
    }
  });

  animationId = requestAnimationFrame(loop);
}

function updAccent(c) {
  document.documentElement.style.setProperty('--accent', c);
  document.documentElement.style.setProperty('--glow', c + '44');
  localStorage.setItem('nx_acc', c);
}

function updBg(i) {
  if (!i.files[0]) return;

  if (i.files[0].size > 3 * 1024 * 1024) {
    alert("Wallpaper too large. Use under 3MB.");
    return;
  }

  const r = new FileReader();
  r.onload = (e) => {
    document.body.style.backgroundImage = `url(${e.target.result})`;
    localStorage.setItem('nx_bg', e.target.result);
  };
  r.readAsDataURL(i.files[0]);
}

function saveSet() {
  const n = document.getElementById('nameIn').value;
  const i = document.getElementById('iconIn').value;

  if (n) {
    document.title = n;
    localStorage.setItem('nx_name', n);
  }

  if (i) {
    document.getElementById('siteIcon').href = i;
    localStorage.setItem('nx_icon', i);
  }
}

function loadSettings() {
  const bg = localStorage.getItem('nx_bg');
  const name = localStorage.getItem('nx_name');
  const icon = localStorage.getItem('nx_icon');
  const acc = localStorage.getItem('nx_acc');
  const emo = localStorage.getItem('nx_emoji');
  const cnt = localStorage.getItem('nx_pcount');
  const pimg = localStorage.getItem('nx_pimg');

  if (bg) document.body.style.backgroundImage = `url(${bg})`;
  if (name) {
    document.title = name;
    document.getElementById('nameIn').value = name;
  }
  if (icon) {
    document.getElementById('siteIcon').href = icon;
    document.getElementById('iconIn').value = icon;
  }
  if (acc) updAccent(acc);
  if (emo) document.getElementById('emojiIn').value = emo;
  if (cnt) {
    document.getElementById('partCount').value = cnt;
    document.getElementById('countVal').innerText = cnt;
  }
  if (pimg) {
    pImg = new Image();
    pImg.src = pimg;
  }
}

function initClock() {
  setInterval(() => {
    document.getElementById('clock').innerText =
      new Date().toLocaleTimeString();
  }, 1000);
}

function initCursor() {
  const c = document.getElementById('cursor');
  window.onmousemove = e => {
    c.style.left = e.clientX + 'px';
    c.style.top = e.clientY + 'px';
  };
}

function closeSidebar(e) {
  if (!document.getElementById('sidebar').contains(e.target)) {
    document.getElementById('sidebar').classList.remove('open');
  }
}

/* ===== FIXED BROWSER LOADER ===== */

function loadURL() {
  const frame = document.getElementById("browserFrame");
  const input = document.getElementById("urlBar").value.trim();

  if (!input) return;

  if (input.startsWith("http://") || input.startsWith("https://")) {
    frame.src = input;
  } else if (input.includes(".")) {
    frame.src = "https://" + input;
  } else {
    frame.src = "https://lite.duckduckgo.com/lite/?q=" +
      encodeURIComponent(input);
  }
}
</script>
